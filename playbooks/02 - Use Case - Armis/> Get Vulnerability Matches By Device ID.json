{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "> Get Vulnerability Matches By Device ID",
    "aliasName": null,
    "tag": null,
    "description": "This Playbook will fetch vulnerability matches in Armis by device id provided.",
    "isActive": false,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "deviceId",
        "vendorTag"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/3bb4552c-051e-43ac-80cd-d7f2c021f1f7",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/91a0b4d4-7f4c-40b4-93e3-ca8a4cebf398",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "No Operation",
            "description": null,
            "arguments": {
                "params": [],
                "version": "3.2.3",
                "connector": "cyops_utilities",
                "operation": "no_op",
                "operationTitle": "Utils: No Operation",
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "7ca38363-b078-4e34-906f-12dfbf72d98b"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Not Found CVEs",
            "description": null,
            "arguments": {
                "when": "{{vars.notFoundCVEId | length > 0}}",
                "for_each": {
                    "item": "{{vars.notFoundCVEId}}",
                    "__bulk": true,
                    "parallel": false,
                    "condition": "",
                    "batch_size": 100
                },
                "resource": {
                    "sSVC": "{{vars.sSVCSchema | toJSON}}",
                    "cVEID": "{{vars.item}}",
                    "__replace": "true",
                    "isInKEVCatalog": "\/api\/3\/picklists\/27ff216f-6363-4c93-9fc4-e0e8c15cb0b1",
                    "__fieldsToUpdate": [
                        "cVEID",
                        "sSVC"
                    ]
                },
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/c_v_es",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": {
                    "__dummy": "{{vars.cVE.extend((vars.steps.Create_Not_Found_CVEs))}}"
                }
            },
            "status": null,
            "top": "705",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "7eb645cd-ed0b-495f-b00a-5e8a49a495f0"
        },
        {
            "@type": "WorkflowStep",
            "name": "Reference Playbook",
            "description": "Iterate over vars.cVE list and fetch ICS Advisory and correlate.",
            "arguments": [],
            "status": null,
            "top": "840",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "871b5ef9-37d7-4d29-96c8-37bbed3ccee5"
        },
        {
            "@type": "WorkflowStep",
            "name": "Find CVEs Record",
            "description": null,
            "arguments": {
                "query": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "primitive",
                            "field": "cVEID",
                            "value": "{{vars.cVEIdList}}",
                            "operator": "in",
                            "_operator": "in"
                        }
                    ],
                    "__selectFields": [
                        "cVEID",
                        "isInKEVCatalog"
                    ]
                },
                "module": "c_v_es?$limit=10000",
                "checkboxFields": true,
                "step_variables": {
                    "__dummy": "{{vars.cVE.extend(vars.steps.Find_CVEs_Record)}}",
                    "foundCVE": "{{vars.steps.Find_CVEs_Record}}",
                    "notFoundCVEId": "{% set data =  vars.steps.Find_CVEs_Record | json_query('[*][\"cVEID\"][]') %}{{vars.cVEIdList | difference(data)}}"
                }
            },
            "status": null,
            "top": "570",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928770",
            "group": null,
            "uuid": "8f30d496-61fb-46a7-99df-98bc7522d220"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    }
                }
            },
            "status": null,
            "top": "30",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "91a0b4d4-7f4c-40b4-93e3-ca8a4cebf398"
        },
        {
            "@type": "WorkflowStep",
            "name": "Remove Special Character",
            "description": null,
            "arguments": {
                "config": "be5d6cca-503d-45c0-b58e-d470e6490443",
                "params": {
                    "python_function": "import re\n\nvendor = {{vars.input}}.get('params').get('vendorTag')\ndef remove_special_characters(string):\n    return re.sub(r'[^\\w\\s]', '', string)\nprint(remove_special_characters(vendor))\n"
                },
                "version": "2.0.1",
                "connector": "code-snippet",
                "operation": "python_inline_code_editor",
                "operationTitle": "Execute Python Code",
                "step_variables": {
                    "cVETagList": "{{vars.steps.Remove_Special_Character.data['code_output']}}"
                }
            },
            "status": null,
            "top": "1110",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/1fdd14cc-d6b4-4335-a3af-ab49c8ed2fd8",
            "group": null,
            "uuid": "aa307e47-0d14-4bd9-833c-0efca5592bf6"
        },
        {
            "@type": "WorkflowStep",
            "name": "Output",
            "description": null,
            "arguments": {
                "cVEResult": "{{vars.cVE}}"
            },
            "status": null,
            "top": "1380",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "b0412658-902b-490d-8f64-9532c80336db"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Latest Report Of CVE",
            "description": null,
            "arguments": {
                "for_each": {
                    "item": "{{vars.cVE}}",
                    "parallel": false,
                    "condition": ""
                },
                "arguments": {
                    "CVERecord": "{{vars.item}}"
                },
                "apply_async": false,
                "step_variables": [],
                "pass_input_record": false,
                "workflowReference": "\/api\/3\/workflows\/efea3161-a3fa-48a8-a239-1e782f8c9ec7"
            },
            "status": null,
            "top": "975",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/74932bdc-b8b6-4d24-88c4-1a4dfbc524f3",
            "group": null,
            "uuid": "c4b94824-0ff8-4e28-a723-d09faf176260"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Vulnerability Matches By Device ID",
            "description": null,
            "arguments": {
                "name": "Armis",
                "config": "e1ef8dae-9a3e-44fb-a96f-a0a08139bf9a",
                "params": {
                    "ids": "{{vars.input.params.deviceId}}",
                    "limit": 1000,
                    "offset": "",
                    "input_type": "Device IDs"
                },
                "version": "1.1.0",
                "connector": "armis",
                "operation": "get_vulnerability_matches",
                "mock_result": "{\"data\": \n    {\n    \"data\": {\n        \"paging\": {\n            \"from\": 0,\n            \"length\": 10,\n            \"next\": null,\n            \"prev\": null,\n            \"to\": 10,\n            \"total\": 10\n        },\n        \"sample\": [\n            {\n                \"advisoryId\": null,\n                \"avmRating\": null,\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2022-1161\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation) PLC Modules:((Slot Indices:['0'] Model:1756-L81ES\/B)) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": null,\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6736\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation) PLC Modules:((Slot Indices:['0'] Model:1756-L81ES\/B)) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": \"MEDIUM\",\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6737\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2022-12-29T22:05:48.670070+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": \"MEDIUM\",\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6738\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2022-12-29T22:05:48.670070+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": null,\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6739\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2022-12-29T22:05:48.670070+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": \"MEDIUM\",\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6740\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2022-12-29T22:05:48.670070+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": \"MEDIUM\",\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6741\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2022-12-29T22:05:48.670070+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": \"LOW\",\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6742\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2023-01-20T10:31:03.467746+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": \"LOW\",\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6743\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2022-12-29T22:05:48.670070+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            },\n            {\n                \"advisoryId\": null,\n                \"avmRating\": \"LOW\",\n                \"confidenceLevel\": \"High\",\n                \"cveUid\": \"CVE-2017-6744\",\n                \"deviceId\": 3225,\n                \"firstDetected\": \"2022-12-29T22:05:48.670070+00:00\",\n                \"lastDetected\": \"2023-04-09T12:50:02.997296+00:00\",\n                \"matchCriteriaString\": \"Hardware:(Rockwell Automation 1756-L81ES\/B) \",\n                \"recommendedSteps\": null,\n                \"remediationTypes\": null,\n                \"status\": \"Open\"\n            }\n        ]\n    },\n    \"success\": true\n}\n}",
                "operationTitle": "Get Vulnerability Matches",
                "pickFromTenant": false,
                "step_variables": {
                    "cVEIdList": "{{vars.steps.Get_Vulnerability_Matches_By_Device_ID.data.data.sample | json_query('[*][\"cveUid\"][]') }}"
                }
            },
            "status": null,
            "top": "300",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "c9741e5a-23d6-4c11-aeaf-36dc41e1016d"
        },
        {
            "@type": "WorkflowStep",
            "name": "Add Vendor Tag On CVEs",
            "description": null,
            "arguments": {
                "when": "{{vars.steps.Remove_Special_Character.data['code_output'] is not none}}",
                "for_each": {
                    "item": "{{vars.cVE}}",
                    "__bulk": true,
                    "parallel": false,
                    "condition": "",
                    "batch_size": 100
                },
                "resource": {
                    "__link": {
                        "recordTags": "{{vars.cVETagList}}"
                    }
                },
                "operation": "Append",
                "collection": "{{vars.item['@id']}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/c_v_es",
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "1245",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "d6c4c8b9-1f9b-4955-9d5b-fc6231af6cae"
        },
        {
            "@type": "WorkflowStep",
            "name": "If Vul Matches Found",
            "description": null,
            "arguments": {
                "conditions": [
                    {
                        "option": "Yes",
                        "step_iri": "\/api\/3\/workflow_steps\/8f30d496-61fb-46a7-99df-98bc7522d220",
                        "condition": "{{ vars.steps.Get_Vulnerability_Matches_By_Device_ID.data.data.sample | length > 0 }}",
                        "step_name": "Find CVEs Record"
                    },
                    {
                        "option": "No",
                        "default": true,
                        "step_iri": "\/api\/3\/workflow_steps\/7ca38363-b078-4e34-906f-12dfbf72d98b",
                        "step_name": "No Operatiopn"
                    }
                ]
            },
            "status": null,
            "top": "435",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "group": null,
            "uuid": "d72a8365-f46a-413b-ad4e-6b48de37f09c"
        },
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "cVE": "[]",
                "cVEResult": "[]",
                "sSVCSchema": "{\n  \"Exploitation\": \"\",\n  \"Technical Impact\": \"\",\n  \"Automatable\": \"\",\n  \"Mission Prevalence\": \"\",\n  \"Well Being\": \"\",\n  \"Mitigation Status\": \"\",\n  \"Automatable Reason\": \"\"\n}",
                "useMockOutput": "{{globalVars.Demo_mode}}"
            },
            "status": null,
            "top": "165",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "fd12ddb3-58eb-47b1-abea-6877b1ddb51e"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Is CVEs Found -> Find CVEs Record",
            "targetStep": "\/api\/3\/workflow_steps\/8f30d496-61fb-46a7-99df-98bc7522d220",
            "sourceStep": "\/api\/3\/workflow_steps\/d72a8365-f46a-413b-ad4e-6b48de37f09c",
            "label": "Yes",
            "isExecuted": false,
            "uuid": "17c8ee5e-6438-4343-b947-9ec12c804694"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Find CVEs Record -> Create Not Found CVEs",
            "targetStep": "\/api\/3\/workflow_steps\/7eb645cd-ed0b-495f-b00a-5e8a49a495f0",
            "sourceStep": "\/api\/3\/workflow_steps\/8f30d496-61fb-46a7-99df-98bc7522d220",
            "label": null,
            "isExecuted": false,
            "uuid": "2aa3639d-55b5-477c-bf2d-dd418132877d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Create Not Found CVEs -> Link ICS Advisory",
            "targetStep": "\/api\/3\/workflow_steps\/871b5ef9-37d7-4d29-96c8-37bbed3ccee5",
            "sourceStep": "\/api\/3\/workflow_steps\/7eb645cd-ed0b-495f-b00a-5e8a49a495f0",
            "label": null,
            "isExecuted": false,
            "uuid": "2b10ba5e-bf6a-43b2-97a6-d2a0546bc8b8"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Reference Playbook -> Get Latest Report Of CVE",
            "targetStep": "\/api\/3\/workflow_steps\/c4b94824-0ff8-4e28-a723-d09faf176260",
            "sourceStep": "\/api\/3\/workflow_steps\/871b5ef9-37d7-4d29-96c8-37bbed3ccee5",
            "label": null,
            "isExecuted": false,
            "uuid": "9c6f3d01-42ae-4bab-b13a-8dd26250b748"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/fd12ddb3-58eb-47b1-abea-6877b1ddb51e",
            "sourceStep": "\/api\/3\/workflow_steps\/91a0b4d4-7f4c-40b4-93e3-ca8a4cebf398",
            "label": null,
            "isExecuted": false,
            "uuid": "9f6c365a-2386-42be-9cf4-4058bce41659"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Add Vendor Tag On CVEs -> Output",
            "targetStep": "\/api\/3\/workflow_steps\/b0412658-902b-490d-8f64-9532c80336db",
            "sourceStep": "\/api\/3\/workflow_steps\/d6c4c8b9-1f9b-4955-9d5b-fc6231af6cae",
            "label": null,
            "isExecuted": false,
            "uuid": "a2b18b11-f236-4285-acc7-de421a89da4a"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get Vulnerability Matches By Device ID -> Is CVEs Found",
            "targetStep": "\/api\/3\/workflow_steps\/d72a8365-f46a-413b-ad4e-6b48de37f09c",
            "sourceStep": "\/api\/3\/workflow_steps\/c9741e5a-23d6-4c11-aeaf-36dc41e1016d",
            "label": null,
            "isExecuted": false,
            "uuid": "bbaf6b52-09f4-4109-940e-2131ea60784d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Remove Special Character -> Add Vendor Tag On CVEs",
            "targetStep": "\/api\/3\/workflow_steps\/d6c4c8b9-1f9b-4955-9d5b-fc6231af6cae",
            "sourceStep": "\/api\/3\/workflow_steps\/aa307e47-0d14-4bd9-833c-0efca5592bf6",
            "label": null,
            "isExecuted": false,
            "uuid": "d0848376-4e15-468b-a165-2e2d96548aed"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Is CVEs Found -> No Operatiopn",
            "targetStep": "\/api\/3\/workflow_steps\/7ca38363-b078-4e34-906f-12dfbf72d98b",
            "sourceStep": "\/api\/3\/workflow_steps\/d72a8365-f46a-413b-ad4e-6b48de37f09c",
            "label": "No",
            "isExecuted": false,
            "uuid": "d5458e86-5f51-4436-aaba-c7c533162fe9"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Get Vulnerability Matches By Device ID",
            "targetStep": "\/api\/3\/workflow_steps\/c9741e5a-23d6-4c11-aeaf-36dc41e1016d",
            "sourceStep": "\/api\/3\/workflow_steps\/fd12ddb3-58eb-47b1-abea-6877b1ddb51e",
            "label": null,
            "isExecuted": false,
            "uuid": "d8419080-8559-4a98-be9f-80c747c91efb"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get Latest Report Of CVE -> Remove Special Character",
            "targetStep": "\/api\/3\/workflow_steps\/aa307e47-0d14-4bd9-833c-0efca5592bf6",
            "sourceStep": "\/api\/3\/workflow_steps\/c4b94824-0ff8-4e28-a723-d09faf176260",
            "label": null,
            "isExecuted": false,
            "uuid": "e00e4c2b-86e4-49e3-b287-a57130c6748a"
        }
    ],
    "groups": [],
    "priority": "\/api\/3\/picklists\/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "uuid": "263cdd64-3b2e-4331-b7e1-26aec697467c",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "Armis",
        "Assets",
        "CVE",
        "Referenced"
    ]
}